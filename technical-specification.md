# Trade Routes - Техническое задание (Прототип)

## 1. Общая информация

**Название проекта:** Trade Routes: Medieval Logistics  
**Тип:** 2D puzzle/strategy игра  
**Платформа:** Web (браузер)  
**Технологический стек:** Phaser 3, JavaScript/TypeScript  
**Цель:** Создание функционального прототипа для проверки геймплейных механик

---

## 2. Технический стек

### Основные технологии
- **Игровой движок:** Phaser 3 (последняя стабильная версия)
- **Язык:** JavaScript (или TypeScript для типизации)
- **Сборка:** Vite / Webpack
- **Графика:** Canvas 2D
- **Целевое разрешение:** 1280x720 (масштабируемое)

### Дополнительные библиотеки
- Pathfinding алгоритмы (A* для караванов)
- Tweening для анимаций (встроенный в Phaser)

---

## 3. Архитектура проекта

### 3.1 Структура файлов
```
/src
  /scenes
    - BootScene.js         # Загрузка ассетов
    - MainMenuScene.js     # Главное меню
    - GameScene.js         # Основная игровая сцена
    - UIScene.js           # Оверлей UI
  /entities
    - City.js              # Класс города
    - Route.js             # Класс торгового пути
    - Caravan.js           # Класс каравана
    - Good.js              # Класс товара
  /managers
    - GameManager.js       # Основная логика игры
    - MapGenerator.js      # Генерация карты
    - EconomyManager.js    # Управление экономикой
    - SeasonManager.js     # Управление сезонами
  /config
    - GameConfig.js        # Конфигурация игры
    - BalanceConfig.js     # Параметры баланса
  /utils
    - PathfindingUtil.js   # Утилиты поиска пути
    - DrawUtil.js          # Утилиты отрисовки
  /assets
    /images
    /audio
```

### 3.2 Основные классы

#### City (Город)
```javascript
class City {
  constructor(x, y, goodType, needs) {
    this.position = {x, y};
    this.produces = goodType;      // Тип производимого товара
    this.needs = needs;             // Массив нужных товаров
    this.inventory = {};            // Текущий инвентарь
    this.satisfaction = 100;        // Уровень удовлетворенности (0-100)
    this.isRiverCity = false;      // У реки или нет
  }
  
  update(delta) {}
  producegood() {}
  receivegood(good) {}
  calculateDemand() {}
}
```

#### Route (Торговый путь)
```javascript
class Route {
  constructor(cities) {
    this.cities = cities;           // Массив городов на маршруте
    this.caravans = [];             // Караваны на маршруте
    this.isRiverRoute = false;     // Речной путь или нет
    this.path = [];                 // Точки пути для движения
  }
  
  addCaravan(caravan) {}
  removeSelf() {}
  draw(graphics) {}
}
```

#### Caravan (Караван)
```javascript
class Caravan {
  constructor(route, capacity) {
    this.route = route;
    this.cargo = [];               // Текущий груз
    this.capacity = capacity;      // Вместимость
    this.currentCityIndex = 0;
    this.speed = 1.0;              // Модификатор скорости
    this.position = {x, y};
  }
  
  update(delta) {}
  loadgood(city) {}
  unloadgood(city) {}
  moveAlongPath() {}
}
```

#### GameManager
```javascript
class GameManager {
  constructor(scene) {
    this.cities = [];
    this.routes = [];
    this.availableRoutes = 2;      // Доступно маршрутов
    this.availableCaravans = 2;    // Караванов на маршрут
    this.caravanCapacity = 3;      // Вместимость караванов
    this.gameTime = 0;             // Игровое время
    this.score = 0;
  }
  
  update(delta) {}
  spawnCity() {}
  createRoute(cities) {}
  checkWinLoseConditions() {}
  grantUpgrade() {}
}
```

---

## 4. Основной функционал (MVP)

### 4.1 Обязательные фичи для прототипа

#### Фаза 1: Базовая механика (Неделя 1)
- [x] Отрисовка карты (статичная сетка)
- [x] Создание городов с иконками товаров
- [x] Проведение торговых путей между городами (клик → клик)
- [x] Базовое движение караванов по путям
- [x] Производство и потребление товаров
- [x] Система инвентаря городов

#### Фаза 2: Игровой цикл (Неделя 2)
- [x] Механика удовлетворенности городов
- [x] Условие поражения (город голодает)
- [x] Таймер игры
- [x] Появление новых городов со временем
- [x] Система улучшений (выбор из 3 вариантов)
- [x] Базовый UI (счет, доступные маршруты, время)

#### Фаза 3: Уникальные механики (Неделя 3)
- [x] Система сезонов (визуальное изменение + эффекты)
- [x] Речные пути (ускоренные маршруты)
- [x] Пересадочные узлы (постоялые дворы)
- [x] Балансировка сложности

#### Фаза 4: Полировка (Неделя 4)
- [x] Звуковые эффекты
- [x] Улучшение визуала (частицы, эффекты)
- [x] Главное меню
- [x] Экран паузы / game over
- [x] Туториал (первые 60 секунд)

### 4.2 Опциональные фичи (если останется время)
- [ ] Различные карты/уровни
- [ ] Таблица лидеров
- [ ] События (ярмарки, войны)
- [ ] Сохранение прогресса
- [ ] Музыкальное сопровождение

---

## 5. Игровой процесс (технические детали)

### 5.1 Цикл игры (Game Loop)

```
Каждый кадр (60 FPS):
1. Update GameManager
   - Увеличить gameTime
   - Проверить условия spawn новых городов
   - Проверить смену сезонов
   
2. Update всех Cities
   - Производить товары (каждые N секунд)
   - Уменьшать satisfaction если нет нужных товаров
   - Проверить критические состояния
   
3. Update всех Caravans
   - Двигаться по пути
   - В городе: загружать/разгружать товары
   - Применять модификаторы скорости (сезон, речной путь)
   
4. Update UI
   - Обновить счетчики
   - Показать предупреждения
   
5. Check Win/Lose
   - Если любой город satisfaction <= 0 → Game Over
```

### 5.2 Ввод игрока

**Создание маршрута:**
1. Игрок кликает на первый город → город подсвечивается
2. Игрок кликает на второй город → создается маршрут
3. Можно продолжать кликать для цепочки городов
4. ПКМ или ESC для отмены

**Удаление маршрута:**
- Клик по линии маршрута → появляется кнопка удаления

**Управление караванами:**
- Автоматическое размещение при создании маршрута
- Возможность добавлять караваны на маршрут (если есть ресурс)

### 5.3 Появление городов

```javascript
// Логика spawn городов
const SPAWN_SCHEDULE = [
  { time: 0, count: 3 },      // Старт: 3 города
  { time: 120, count: 1 },    // +1 город через 2 минуты
  { time: 240, count: 1 },    // +1 город через 4 минуты
  { time: 360, count: 2 },    // +2 города через 6 минут
  // Далее каждые 90 секунд по 1 городу
];
```

Города появляются в случайных позициях с учетом:
- Минимального расстояния от других городов
- 30% шанс быть у реки
- Случайный тип производимого товара
- 1-3 случайных потребности

### 5.4 Система улучшений

Улучшения предлагаются каждые 2 минуты игрового времени.

**Типы улучшений:**
1. **Дополнительный маршрут** (+1 к доступным маршрутам)
2. **Больше караванов** (+1 караван на все маршруты)
3. **Увеличенная вместимость** (+2 к capacity всех караванов)
4. **Речной путь** (разблокировать речные маршруты)
5. **Постоялый двор** (разместить узел для пересадок)
6. **Быстрые кони** (+30% скорость всем караванам)

---

## 6. Система сезонов

### 6.1 Параметры сезонов

| Сезон  | Длительность | Эффект на сухопутные пути | Эффект на речные |
|--------|--------------|---------------------------|------------------|
| Весна  | 150 сек      | -10% скорость (грязь)     | Норма            |
| Лето   | 150 сек      | Норма                     | Норма            |
| Осень  | 150 сек      | -10% скорость (дожди)     | Норма            |
| Зима   | 150 сек      | -30% скорость (снег)      | Норма (не мерзнут)|

### 6.2 Визуальные изменения
- Цвет фона меняется
- Иконки городов меняют оттенок
- Появляются эффекты (снежинки зимой, листья осенью)

---

## 7. Баланс (числовые параметры)

```javascript
const BALANCE = {
  // Производство
  PRODUCTION_INTERVAL: 5000,        // мс между производством товара
  
  // Города
  CITY_STARTING_SATISFACTION: 100,
  SATISFACTION_DECAY_RATE: 2,       // единиц в секунду если нет товара
  SATISFACTION_INCREASE: 20,        // при получении нужного товара
  CRITICAL_SATISFACTION: 30,        // порог предупреждения
  
  // Караваны
  CARAVAN_BASE_SPEED: 50,           // пикселей в секунду
  CARAVAN_STARTING_CAPACITY: 3,
  
  // Маршруты
  STARTING_ROUTES: 2,
  STARTING_CARAVANS_PER_ROUTE: 2,
  
  // Расстояния
  MIN_CITY_DISTANCE: 150,           // минимум между городами
  RIVER_SPEED_BONUS: 1.5,           // множитель скорости на реке
  
  // Время
  UPGRADE_INTERVAL: 120000,         // 2 минуты
  TARGET_GAME_LENGTH: 600000,       // 10 минут для прохождения
};
```

---

## 8. Визуальный стиль (технические требования)

### 8.1 Цветовая палитра
```javascript
const COLORS = {
  background: '#f5e6d3',     // Бежевый пергамент
  cityFill: '#8b7355',       // Коричневый
  cityStroke: '#5a4a3a',
  routeLine: '#6b5544',      // Темно-коричневый пунктир
  riverBlue: '#6ba3d4',
  seasonSpring: '#a8d08d',   // Зеленоватый
  seasonSummer: '#ffd966',   // Желтоватый
  seasonAutumn: '#e07a3e',   // Оранжевый
  seasonWinter: '#c5d9e8',   // Голубоватый
};
```

### 8.2 Размеры элементов
- Город: 40x40 пикселей (круг)
- Иконка товара: 24x24 пикселей
- Караван: 20x20 пикселей (ромб)
- Линия маршрута: 3 пикселя (пунктир: 10px линия, 5px пробел)
- Река: 30 пикселей ширина (волнистая линия)

### 8.3 Шрифты
- UI текст: Arial, 16-24px
- Числа/счетчики: Monospace, 18px
- Заголовки: Arial Bold, 32px

---

## 9. UI элементы

### 9.1 HUD (постоянный интерфейс)

**Верхняя панель:**
- Игровое время (MM:SS)
- Текущий счет
- Текущий сезон (иконка + название)

**Правая панель:**
- Доступные маршруты (N/M)
- Доступные караваны (иконки)
- Кнопка паузы

**Нижняя панель (при выборе города):**
- Производит: [иконка товара]
- Нуждается в: [иконки товаров]
- Уровень удовлетворенности: прогресс-бар

### 9.2 Окна

**Окно улучшения:**
- Появляется по центру экрана
- 3 карточки с вариантами улучшений
- Описание каждого улучшения
- Игра на паузе

**Окно Game Over:**
- Итоговый счет
- Время игры
- Кнопка "Restart"
- Кнопка "Main Menu"

---

## 10. Оптимизация производительности

### 10.1 Целевые показатели
- **FPS:** Стабильные 60 FPS
- **Максимум объектов:** 50 городов, 20 маршрутов, 100 караванов
- **Время загрузки:** < 3 секунды

### 10.2 Методы оптимизации
1. **Object pooling** для караванов (переиспользование объектов)
2. **Spatial hashing** для проверки коллизий кликов
3. **Кэширование путей** (не пересчитывать A* каждый кадр)
4. **Отключение update** для объектов вне экрана
5. **Batch rendering** для статичных элементов (карта)

---

## 11. Тестирование

### 11.1 Функциональное тестирование

**Чек-лист основных механик:**
- [ ] Города производят товары через заданный интервал
- [ ] Караваны загружают товары при остановке в городе
- [ ] Караваны разгружают нужные товары в городах
- [ ] Удовлетворенность падает без товаров
- [ ] Удовлетворенность восстанавливается при доставке
- [ ] Game Over при satisfaction = 0
- [ ] Новые города появляются по расписанию
- [ ] Улучшения работают корректно
- [ ] Сезоны меняются и влияют на скорость
- [ ] Речные пути быстрее сухопутных

### 11.2 Баланс-тестирование
- Проверить прохождение 10 минут с разными стратегиями
- Убедиться что все типы улучшений полезны
- Проверить что сложность растет плавно
- Проверить отсутствие "блокирующих" ситуаций

### 11.3 UX тестирование
- Понятен ли геймплей без туториала
- Читаемы ли иконки и UI
- Нет ли фрустрации от скорости игры

---

## 12. Релиз прототипа

### 12.1 Деплой
- Собрать production build
- Залить на статичный хостинг (GitHub Pages / Netlify / Vercel)
- Убедиться что работает на десктопе и мобильных браузерах

### 12.2 Сбор обратной связи
- Ссылка на форму для фидбека
- Метрики: средняя длительность игры, момент game over
- Тепловая карта кликов (опционально)

---

## 13. Дальнейшее развитие (после прототипа)

Если прототип успешен, возможные направления:
1. Портирование на мобильные платформы
2. Добавление meta-прогрессии (разблокировка карт)
3. Multiplayer режим (кооператив)
4. Интеграция с Telegram Mini Apps
5. Монетизация (реклама / покупка новых карт)

---

## 14. Контакты и документация

**Разработчик:** Aleksandr  
**Репозиторий:** [ссылка на GitHub]  
**Дизайн документ:** game-design-document.md  
**Дата создания ТЗ:** 10 ноября 2025
